<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> Risk Matrix — Entry • Exposure • Establishment • Impact • Overall</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        :root {
            --gap: 16px;
            --card-bg: #1a1f2b;
            --ink: #e0e6ff;
            --muted: #7b89a3;
            --soft: #2a3142;
            --accent: #6b5eff;
            --glow: #8a7cff;
            --gradient: linear-gradient(135deg, #6b5eff, #ff6b6b);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 32px;
            background: var(--gradient);
            color: var(--ink);
            font-family: Arial, Helvetica, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        h2 {
            margin: 0 0 12px 0;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--glow);
            text-shadow: 0 0 8px rgba(107, 94, 255, 0.5);
        }

        .wrap {
            width: min(1400px, 100%);
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: var(--gap);
            animation: fadeIn 1s ease-out;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(107, 94, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4), inset 0 0 15px rgba(107, 94, 255, 0.3);
        }

        .controls {
            display: grid;
            gap: 12px;
        }

        .controls .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="range"] {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 10px;
            background: var(--soft);
            color: var(--ink);
            font-family: Arial, Helvetica, sans-serif;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        select:hover,
        input[type="range"]:hover {
            background: #3a4256;
            transform: scale(1.02);
        }

        .btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            background: var(--soft);
            color: var(--ink);
            font-family: Arial, Helvetica, sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.4s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: var(--accent);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(107, 94, 255, 0.5);
        }

        #playBtn {
            background: #2ecc71;
        }

        #playBtn:hover {
            background: #25b863;
        }

        #recWebmBtn {
            background: #2962ff;
        }

        #recWebmBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #status {
            font-size: 12px;
            color: #fff;
            padding: 6px 12px;
            background: var(--accent);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(107, 94, 255, 0.3);
            animation: pulse 2s infinite;
        }

        .ratings {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }

        .ratings .item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .canvas-card {
            padding: 0;
            overflow: visible;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(107, 94, 255, 0.2);
            background: #232a3b;
            border-radius: 16px 16px 0 0;
        }

        .info {
            color: var(--muted);
            font-size: 14px;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: #1a1f2b;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-weight: 700;
            background: var(--accent);
            color: #fff;
            box-shadow: 0 0 10px rgba(107, 94, 255, 0.4);
            transition: transform 0.3s ease;
        }

        .pill:hover {
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 10px rgba(107, 94, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(107, 94, 255, 0.6);
            }
            100% {
                box-shadow: 0 0 10px rgba(107, 94, 255, 0.3);
            }
        }

        @media (max-width: 980px) {
            .wrap {
                grid-template-columns: 1fr;
            }
            .ratings {
                grid-template-columns: 1fr;
            }
            body {
                padding: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- Left: Controls + Ratings -->
        <div class="card">
            <h2>Controls</h2>
            <div class="controls">
                <div class="row">
                    <div>
                        <label>Shape</label>
                        <select id="shapeSel">
                            <option>Bug</option>
                            <option>Virus</option>
                            <option>Spore</option>
                        </select>
                    </div>
                    <div>
                        <label>Speed (faster → slower)</label>
                        <input id="speed" type="range" min="30" max="200" step="5" value="110">
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label>Min size</label>
                        <input id="sizeMin" type="range" min="6" max="40" step="1" value="10">
                    </div>
                    <div>
                        <label>Max size</label>
                        <input id="sizeMax" type="range" min="30" max="200" step="1" value="150">
                    </div>
                </div>
                <div class="btns">
                    <button id="playBtn">Play</button>
                    <button id="pauseBtn">Pause</button>
                    <button id="recWebmBtn" title="Record WebM">Record WebM</button>
                    <button id="stopSaveBtn" disabled>Stop &amp; Save</button>
                    <span id="status">Idle</span>
                </div>
            </div>

            <h2 style="margin-top: 16px;">Ratings</h2>
            <div class="ratings">
                <div class="item">
                    <label>Entry</label>
                    <select id="entrySel">
                        <option>High</option>
                        <option selected>Moderate</option>
                        <option>Low</option>
                        <option>Very Low</option>
                        <option>Negligible</option>
                    </select>
                </div>
                <div class="item">
                    <label>Exposure</label>
                    <select id="exposureSel">
                        <option>High</option>
                        <option>Moderate</option>
                        <option selected>Low</option>
                        <option>Very Low</option>
                        <option>Negligible</option>
                    </select>
                </div>
                <div class="item">
                    <label>Establishment</label>
                    <select id="estabSel">
                        <option>High</option>
                        <option selected>Moderate</option>
                        <option>Low</option>
                        <option>Very Low</option>
                        <option>Negligible</option>
                    </select>
                </div>
                <div class="item">
                    <label>Impact (Consequence)</label>
                    <select id="econSel">
                        <option>Very High</option>
                        <option>High</option>
                        <option selected>Moderate</option>
                        <option>Low</option>
                        <option>Very Low</option>
                        <option>Negligible</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Right: Canvas -->
        <div class="card canvas-card">
            <div class="header">
                <div class="info">
                    <span id="likeInfo" class="pill">Combined likelihood: —</span>
                    &nbsp;&nbsp;
                    <span id="riskInfo" class="pill">Overall risk: —</span>
                </div>
            </div>
            <!-- p5 canvas injected here -->
        </div>
    </div>

    <script>
        // ============ NZ MATRICES ============

        // Table 5-4 (corrected): High×Very Low → Low, High×Low → Moderate
        const TABLE_5_4 = {
            "Negligible": { "Negligible": "Negligible", "Very Low": "Negligible", "Low": "Negligible", "Moderate": "Negligible", "High": "Negligible" },
            "Very Low": { "Negligible": "Negligible", "Very Low": "Negligible", "Low": "Very Low", "Moderate": "Very Low", "High": "Low" },
            "Low": { "Negligible": "Negligible", "Very Low": "Very Low", "Low": "Very Low", "Moderate": "Low", "High": "Moderate" },
            "Moderate": { "Negligible": "Negligible", "Very Low": "Very Low", "Low": "Low", "Moderate": "Moderate", "High": "Moderate" },
            "High": { "Negligible": "Negligible", "Very Low": "Low", "Low": "Moderate", "Moderate": "Moderate", "High": "High" }
        };
        function combine2(a, b) { return TABLE_5_4[a][b]; }
        function combine3(entry, exposure, establishment) {
            // Entry ⊗ Exposure, then ⊗ Establishment
            return combine2(combine2(entry, exposure), establishment);
        }

        // ==== TABLE 5-6 (as in your code) ====
        const TABLE_5_6 = {
                "Negligible": {
                    "Negligible": "Negligible", "Very Low": "Negligible", "Low": "Negligible",
                    "Moderate": "Negligible", "High": "Negligible", "Very High": "Negligible"
                },
                "Exceptionally Low": {
                    "Negligible": "Not Applicable", "Very Low": "Not Applicable", "Low": "Not Applicable",
                    "Moderate": "Negligible", "High": "Very Low", "Very High": "Very Low"
                },
                "Very Very Low": {
                    "Negligible": "Not Applicable", "Very Low": "Not Applicable", "Low": "Not Applicable",
                    "Moderate": "Very Low", "High": "Low", "Very High": "Low"
                },
                "Very Low": {
                    "Negligible": "Negligible", "Very Low": "Negligible", "Low": "Very Low",
                    "Moderate": "Low", "High": "Low", "Very High": "Moderate"
                },
                "Low": {
                    "Negligible": "Negligible", "Very Low": "Very Low", "Low": "Low",
                    "Moderate": "Moderate", "High": "Moderate", "Very High": "High"
                },
                "Moderate": {
                    "Negligible": "Negligible", "Very Low": "Very Low", "Low": "Low",
                    "Moderate": "Moderate", "High": "High", "Very High": "Very High"
                },
                "High": {
                    "Negligible": "Negligible", "Very Low": "Very Low", "Low": "Low",
                    "Moderate": "Moderate", "High": "High", "Very High": "Very High"
                }
            };
        function overallRisk(like, impact) {
            return TABLE_5_6[like] && TABLE_5_6[like][impact] ? TABLE_5_6[like][impact] : "Not Applicable";
        }

        // Scalars with wider spread for better visibility
        const likeToScalar = lvl => ({
            "High": 1.20,       // Largest
            "Moderate": 1.00,   // Noticeable drop
            "Low": 0.75,        // Further drop
            "Very Low": 0.50,   // Smaller
            "Negligible": 0.25  // Smallest
        })[lvl];

        const impactToScalar = imp => ({
            "Very High": 1.20,  // Largest
            "High": 1.00,       // Noticeable drop
            "Moderate": 0.75,   // Further drop
            "Low": 0.50,        // Smaller
            "Very Low": 0.30,   // Even smaller
            "Negligible": 0.10  // Smallest
        })[imp];

        const riskToScalar = risk => ({
            "Very High": 1.20,  // Largest
            "High": 1.00,       // Noticeable drop
            "Moderate": 0.75,   // Further drop
            "Low": 0.50,        // Smaller
            "Very Low": 0.30,   // Even smaller
            "Very very low": 0.20,
            "Exceptionally low": 0.15,
            "Negligible": 0.10,
            "Not Applicable": 0.10
        })[risk];

        // ============ p5 + recording ============

        const CAN_W = 1150, CAN_H = 440;

        // UI refs
        let shapeSel, speedSlider, sMinSlider, sMaxSlider;
        let entrySel, exposureSel, estabSel, econSel;
        let playBtn, pauseBtn, statusEl, recWebmBtn, stopSaveBtn;
        let likeInfo, riskInfo;

        // Animation state
        let t = 0;
        let paused = false, finished = false;

        // Recording
        let canvasEl = null, capturing = false, mediaRecorder = null, webmChunks = [];

        // Particle system
        let particles = [];
        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.vx = random(-1, 1); this.vy = random(-1, 1);
                this.size = random(2, 6);
                this.alpha = random(50, 150);
                this.life = random(30, 60);
            }
            update() { this.x += this.vx; this.y += this.vy; this.life--; this.alpha *= 0.95; }
            draw() { noStroke(); fill(107, 94, 255, this.alpha); circle(this.x, this.y, this.size); }
        }

        // Load virus image
        let virusImg;
        function preload() {
            virusImg = loadImage('virus.png');
        }

        function setup() {
            const cnv = createCanvas(CAN_W, CAN_H);
            document.querySelector('.canvas-card').appendChild(cnv.canvas);
            canvasEl = cnv.canvas;
            pixelDensity(1); noStroke(); textFont('Arial', 12);

            // Wire UI
            shapeSel = document.getElementById('shapeSel');
            speedSlider = document.getElementById('speed');
            sMinSlider = document.getElementById('sizeMin');
            sMaxSlider = document.getElementById('sizeMax');
            entrySel = document.getElementById('entrySel');
            exposureSel = document.getElementById('exposureSel');
            estabSel = document.getElementById('estabSel');
            econSel = document.getElementById('econSel');
            playBtn = document.getElementById('playBtn');
            pauseBtn = document.getElementById('pauseBtn');
            statusEl = document.getElementById('status');
            recWebmBtn = document.getElementById('recWebmBtn');
            stopSaveBtn = document.getElementById('stopSaveBtn');
            likeInfo = document.getElementById('likeInfo');
            riskInfo = document.getElementById('riskInfo');

            playBtn.onclick = () => restart();
            pauseBtn.onclick = () => { if (!finished) { paused = !paused; setStatus(paused ? 'Paused' : 'Playing'); } };
            recWebmBtn.onclick = () => startRecordingWebM();
            stopSaveBtn.onclick = () => stopAndSaveRecording();

            setStatus('Idle');

            // GSAP UI flair
            gsap.from(".card", { duration: 1, y: 50, opacity: 0, stagger: 0.2, ease: "power2.out" });
            gsap.from(".controls .row", { duration: 0.8, x: -20, opacity: 0, stagger: 0.1, delay: 0.5, ease: "power2.out" });
            gsap.from(".ratings .item", { duration: 0.8, x: 20, opacity: 0, stagger: 0.1, delay: 0.7, ease: "power2.out" });
        }

        function restart() { t = 0; paused = false; finished = false; setStatus('Playing'); loop(); }
        function setStatus(msg) { statusEl.textContent = msg; }

        function startRecordingWebM() {
            if (capturing) return;
            restart();
            const stream = canvasEl.captureStream(30);
            webmChunks = [];
            try { mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' }); }
            catch (e) { mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' }); }
            mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) webmChunks.push(e.data); };
            mediaRecorder.onstop = async () => {
                const blob = new Blob(webmChunks, { type: 'video/webm' });
                await saveBlobWithDialog(blob, 'risk_pathway_nz.webm', 'video/webm');
                setStatus('Saved WebM ✅'); mediaRecorder = null;
            };
            mediaRecorder.start();
            capturing = true; recWebmBtn.disabled = true; stopSaveBtn.disabled = false;
            setStatus('Recording WebM…');
        }

        async function stopAndSaveRecording() {
            if (!capturing) return;
            stopSaveBtn.disabled = true; setStatus('Finalising WebM…');
            if (mediaRecorder) mediaRecorder.stop();
            capturing = false; recWebmBtn.disabled = false; stopSaveBtn.disabled = true;
        }

        async function saveBlobWithDialog(blob, suggestedName, mime) {
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName,
                        types: [{ description: 'WebM', accept: { [mime]: ['.webm'] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob); await writable.close(); return;
                } catch (e) { /* user cancelled; fall back */ }
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = suggestedName;
            document.body.appendChild(a); a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 100);
        }

        function draw() {
            background(26, 31, 43);

            // Ambient particles
            if (!paused && random() < 0.3) particles.push(new Particle(random(width), random(height)));
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => { p.update(); p.draw(); });

            // Dynamic margins to avoid clipping
            const MAX_S = Number(sMaxSlider.value);
            const margin = MAX_S / 2 + 28;
            const X0 = margin, X5 = width - margin;
            const X1 = X0 + (X5 - X0) * 0.20;
            const X2 = X0 + (X5 - X0) * 0.40;
            const X3 = X0 + (X5 - X0) * 0.60;
            const X4 = X0 + (X5 - X0) * 0.80;
            const Y = height / 2 + 10;

            // Path & ticks
            stroke(107, 94, 255, 150); strokeWeight(3);
            line(X0, Y, X5, Y);
            [X0, X1, X2, X3, X4].forEach(x => {
                line(x, Y - 10, x, Y + 10);
                noStroke(); fill(107, 94, 255, 50); circle(x, Y, 12);
            });
            noStroke();

            // Tick labels
            fill(224, 230, 255); textAlign(CENTER);
            text('Entry', X0, Y + 28);
            text('Exposure', X1, Y + 28);
            text('Establishment', X2, Y + 28);
            text('Impact', X3, Y + 28);
            text('Overall', X4, Y + 28);

            // Inputs → ratings
            const S_MIN = Number(sMinSlider.value), S_MAX = Number(sMaxSlider.value);
            const entryLike = entrySel.value;
            const exposureLike = exposureSel.value;
            const estabLike = estabSel.value;
            const combinedLike = combine3(entryLike, exposureLike, estabLike);
            const impact = econSel.value;
            const risk = overallRisk(combinedLike, impact);

            likeInfo.textContent = `Combined likelihood: ${combinedLike}`;
            riskInfo.textContent = `Overall risk: ${risk}`;

            // Sizes preview per node
            const sEntry = lerp(S_MIN, S_MAX, likeToScalar(entryLike));
            const sExpos = lerp(S_MIN, S_MAX, likeToScalar(exposureLike));
            const sEstab = lerp(S_MIN, S_MAX, likeToScalar(estabLike));
            const sImpact = lerp(S_MIN, S_MAX, impactToScalar(impact));
            const sOverall = lerp(S_MIN, S_MAX, riskToScalar(risk));

            // Time evolution 0..4 across phases
            if (!paused && !finished) {
                const speedDiv = Number(speedSlider.value);
                t += (1 / speedDiv) * 1;
                if (t >= 4) { t = 4; finished = true; if (!capturing) noLoop(); setStatus('Finished'); }
            }

            // Interpolate position/size + label content
            let x, s, label;
            if (t <= 1) {
                x = map(t, 0, 1, X0, X1); s = lerp(sEntry, sExpos, t); label = entryLike;
            } else if (t <= 2) {
                x = map(t, 1, 2, X1, X2); s = lerp(sExpos, sEstab, t - 1); label = exposureLike;
            } else if (t <= 3) {
                x = map(t, 2, 3, X2, X3); s = lerp(sEstab, sImpact, t - 2); label = estabLike;
            } else {
                x = map(t, 3, 4, X3, X4); s = lerp(sImpact, sOverall, t - 3); label = (t === 4) ? risk : impact;
            }

            // Colour by size
            const col = colourForSize(s, S_MIN, S_MAX);
            fill(col.fill[0], col.fill[1], col.fill[2]);
            stroke(col.stroke[0], col.stroke[1], col.stroke[2]); strokeWeight(2);

            // Marker with glow
            drawingContext.shadowBlur = 15;
            drawingContext.shadowColor = `rgba(${col.fill[0]}, ${col.fill[1]}, ${col.fill[2]}, 0.5)`;
            drawMarker(shapeSel.value, x, Y, s);
            drawingContext.shadowBlur = 0;

            // Floating label (bold value only)
            push();
            const bold = label;
            const tw = textWidth(bold) + 16, th = 24;
            textAlign(CENTER, BOTTOM);
            noStroke(); fill(26, 31, 43, 220); rectMode(CENTER);
            rect(x, Y - s - 24, tw, th, 10);
            fill(224, 230, 255); textStyle(BOLD); text(bold, x, Y - s - 10); textStyle(NORMAL);
            pop();

            // Node previews
            drawNodePreview(X0, Y, sEntry);
            drawNodePreview(X1, Y, sExpos);
            drawNodePreview(X2, Y, sEstab);
            drawNodePreview(X3, Y, sImpact);
            drawNodePreview(X4, Y, sOverall);
        }

        function drawNodePreview(x, y, s) {
            push();
            noStroke();
            fill(107, 94, 255, 100);
            drawingContext.shadowBlur = 10;
            drawingContext.shadowColor = 'rgba(107, 94, 255, 0.5)';
            circle(x, y - 26, Math.max(10, Math.min(20, s)));
            drawingContext.shadowBlur = 0;
            pop();
        }

        function colourForSize(s, smin, smax) {
            const u0 = (s - smin) / (smax - smin + 1e-6);
            let u = Math.max(0, Math.min(1, u0));
            const lerp3 = (a, b, t) => Math.round(a + (b - a) * t);
            const c1 = { fill: [80, 140, 255], stroke: [40, 90, 210] };   // low
            const c2 = { fill: [255, 165, 60], stroke: [210, 120, 40] };  // medium
            const c3 = { fill: [235, 87, 87], stroke: [200, 60, 60] };   // high
            let f, g;
            if (u < 0.5) { f = c1; g = c2; u = u / 0.5; } else { f = c2; g = c3; u = (u - 0.5) / 0.5; }
            return {
                fill: [lerp3(f.fill[0], g.fill[0], u), lerp3(f.fill[1], g.fill[1], u), lerp3(f.fill[2], g.fill[2], u)],
                stroke: [lerp3(f.stroke[0], g.stroke[0], u), lerp3(f.stroke[1], g.stroke[1], u), lerp3(f.stroke[2], g.stroke[2], u)]
            };
        }

        function drawMarker(type, x, y, s) {
            push(); noStroke(); textAlign(CENTER, CENTER);
            switch (type) {
                case "Bug":
                    textSize(s * 1.2);
                    text('🪰', x, y + s * 0.05);
                    break;
                case "Virus":
                    image(virusImg, x - s / 2, y - s / 2, s, s);
                    break;
                case "Spore":
                    circle(x, y, s, s);
                    fill(255, 255, 255, 120); circle(x, y, s * 0.38);
                    break;
            }
            pop();
        }

        function mousePressed() {
            if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height && !finished) {
                paused = !paused; setStatus(paused ? 'Paused' : 'Playing');
            }
        }
    </script>
